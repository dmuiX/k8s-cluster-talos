machine:
  install:
    image: factory.talos.dev/installer/${SCHEMATIC_ID}:v1.11.2
  network:
    hostname: ${NODE_NAME}
    interfaces:
      - deviceSelector:
          hardwareAddr: ${MAC}
        dhcp: false
        addresses:
          - ${IP}/24
        routes:
          - network: 0.0.0.0/0
            gateway: ${GATEWAY}
    nameservers: ${NAMESERVERS_ARRAY}
  time:
    servers:
      - 192.168.1.1 
      - time.cloudflare.com
  kubelet:
    extraMounts:
      - destination: /var/lib/longhorn
        type: bind
        source: /var/lib/longhorn
        options:
          - bind
          - rshared
          - rw
    clusterDNS:
      - 10.96.0.10
    extraConfig:
      allowedUnsafeSysctls:
        - net.*
        - kernel.msg*
        - kernel.shm*
        - kernel.sem
    extraArgs:
      rotate-server-certificates: true
  sysctls:
    vm.nr_hugepages: "1024"
    net.ipv4.ip_forward: "1"
    net.bridge.bridge-nf-call-iptables: "1"
    net.ipv6.conf.all.forwarding: "1"
  kernel:
    modules:
      - name: br_netfilter
      - name: overlay
      - name: nvme_tcp
      - name: vfio_pci
  files:
    - content: |-
        [metrics]
        address = "0.0.0.0:11234"
        grpc_histogram = false
      path: /var/cri/conf.d/metrics.toml
      op: create
cluster:
  apiServer:
    admissionControl:
      - name: PodSecurity
        configuration:
          apiVersion: pod-security.admission.config.k8s.io/v1
          kind: PodSecurityConfiguration
          defaults:
            enforce: baseline
            enforce-version: latest
            audit: restricted
            audit-version: latest
            warn: restricted
            warn-version: latest
          exemptions:
            usernames: []
            runtimeClasses: []
            namespaces:
              - cilium
  network:
    cni:
      name: none
  proxy:
    disabled: true
  allowSchedulingOnControlPlanes: false
  extraManifests:
    - https://raw.githubusercontent.com/alex1989hu/kubelet-serving-cert-approver/main/deploy/standalone-install.yaml
    - https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml
    - https://github.com/kubernetes-sigs/gateway-api/releases/download/v1.4.0/standard-install.yaml
    - https://github.com/kubernetes-sigs/gateway-api/releases/download/v1.4.0/experimental-install.yaml
